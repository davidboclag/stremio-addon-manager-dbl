<div class="d-flex justify-content-between align-items-center mb-3">
  <h4>Instalador rápido de Addons Stremio Web</h4>
  <div>
    <button class="btn btn-outline-danger btn-sm me-2" (click)="logout()">
      Cerrar sesión
    </button>
    <button class="btn btn-outline-secondary btn-sm" (click)="reloadAddons()">
      Recargar addons
    </button>
  </div>
</div>

<!-- Token Real-Debrid -->
<div class="card mb-3">
  <div class="card-body">
    <label class="form-label">
      Token Real-Debrid
      <small class="text-muted ms-2">
        (Obtén tu token en
        <a href="https://real-debrid.com/devices" target="_blank" rel="noopener noreferrer">
          real-debrid.com/devices
        </a>)
      </small>
    </label>
    
    <div class="input-group mb-2">
      <input
        [(ngModel)]="rdTokenInput"
        class="form-control"
        placeholder="Token (52 chars)"
        (input)="onTokenChange($event)"
      />
      <button class="btn btn-outline-secondary" (click)="copyToken()">
        <i class="bi bi-clipboard"></i>
      </button>
    </div>

    @if (rdService.user(); as user) {
      <div class="alert alert-success py-2">
        ✅ Conectado como: {{ user.username }}
      </div>
    }

    <div class="d-flex gap-2 flex-wrap">
      <button
        class="btn btn-danger"
        (click)="configureAll()"
        [disabled]="isLoading()"
      >
        <i class="bi bi-cloud-download me-1"></i>
        Instalar preconfiguración recomendada
      </button>
      
      <button
        class="btn btn-secondary"
        (click)="resetStremio()"
        [disabled]="isLoading()"
      >
        <i class="bi bi-arrow-counterclockwise me-1"></i>
        Volver al estado de fábrica
      </button>
    </div>
  </div>
</div>

<!-- Overlay de carga -->
@if (isLoading()) {
  <div class="global-overlay">
    <div class="card bg-dark text-light shadow-lg mx-auto" style="min-width: 320px; max-width: 400px;">
      <div class="card-body text-center">
        <div class="d-flex justify-content-center mb-3">
          <div class="spinner-border text-light" style="width: 3rem; height: 3rem;" role="status">
            <span class="visually-hidden">Cargando...</span>
          </div>
        </div>
        <h5 class="fw-semibold mb-2">{{ loadingTitle() }}</h5>
        <p class="mb-0">{{ progressText() }}</p>
      </div>
    </div>
  </div>
}

<app-addons 
  [stremioAuthKey]="stremio.authKey() || ''" 
  [rdToken]="rdService.token() || ''"
  (refreshRequested)="reloadAddons()"
/>

<!-- Iframes dinámicos para instalar addons -->
@for (iframeUrl of iframeUrls; track iframeUrl) {
  <div class="mb-3">
    <iframe
      [src]="iframeUrl"
      width="100%"
      height="480"
      style="border: 1px solid #ccc; border-radius: 8px"
    ></iframe>
  </div>
}

<app-addon-tabs 
  [addons]="addons" 
  [token]="rdService.token() || ''"
/>