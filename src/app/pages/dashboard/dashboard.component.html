<main>
  <section aria-labelledby="debrid-section-title" class="card shadow-sm mb-4">
    <div class="card-body">
      <div class="row g-3">
        <!-- Selector de idioma -->
        <div class="col-md-4">
          <div class="d-flex align-items-center mb-3">
            <i
              class="bi bi-translate text-info me-2 fs-5"
              aria-hidden="true"
            ></i>
            <label for="languageSelect" class="form-label mb-0 fw-semibold">
              {{ "DASHBOARD.DEBRID_SECTION.LANGUAGE_SELECTOR" | translate }}
            </label>
          </div>
          <select
            id="languageSelect"
            class="form-select"
            [(ngModel)]="selectedLanguage"
            aria-describedby="languageHelp"
          >
            @for (lang of languageOptions(); track lang.key) {
            <option [value]="lang.key">
              {{ lang.config.flag }} {{ lang.config.nativeName }}
            </option>
            }
          </select>
          <div id="languageHelp" class="form-text">
            {{ "DASHBOARD.DEBRID_SECTION.LANGUAGE_HELP" | translate }}
          </div>
        </div>

        <!-- Selector de proveedor Debrid -->
        <div class="col-md-4">
          <div class="d-flex align-items-center mb-3">
            <i
              class="bi bi-cloud-arrow-down text-primary me-2 fs-5"
              aria-hidden="true"
            ></i>
            <label
              for="debridProviderSelect"
              class="form-label mb-0 fw-semibold"
            >
              {{ "DASHBOARD.DEBRID_SECTION.DEBRID_PROVIDER" | translate }}
            </label>
          </div>
          <select
            id="debridProviderSelect"
            class="form-select"
            [(ngModel)]="selectedDebridProvider"
            (ngModelChange)="onDebridProviderChange($event)"
            aria-describedby="debridProviderHelp"
          >
            <option value="">
              {{ "DASHBOARD.DEBRID_SECTION.NO_SERVICE" | translate }}
            </option>
            @for (service of debridService.availableServices(); track
            service.id) {
            <option [value]="service.id">
              {{ service.displayName }}
            </option>
            }
          </select>
          <div id="debridProviderHelp" class="form-text">
            @if (debridService.currentService()) {
            <small>
              <a
                [href]="debridService.currentService()!.signupUrl"
                target="_blank"
                rel="noopener noreferrer"
                class="text-decoration-none"
              >
                {{ "DASHBOARD.DEBRID_SECTION.SIGNUP_LINK" | translate }}
                {{ debridService.currentService()!.displayName }}
                <i class="bi bi-box-arrow-up-right ms-1" aria-hidden="true"></i>
              </a>
            </small>
            }
          </div>
        </div>

        <!-- Token del proveedor -->
        @if (debridService.currentService()) {
        <div class="col-md-4">
          <div class="d-flex align-items-center mb-3">
            <i
              class="bi bi-shield-check text-success me-2 fs-5"
              aria-hidden="true"
            ></i>
            <label for="debridTokenInput" class="form-label mb-0 fw-semibold">
              Token {{ debridService.currentService()!.displayName }}
            </label>
            <small class="text-muted ms-2">
              ({{ debridService.currentService()!.tokenLength }}
              {{ "COMMON.CHARACTERS" | translate }})
            </small>
          </div>
          <div class="input-group mb-3">
            <span class="input-group-text">
              <i class="bi bi-key" aria-hidden="true"></i>
            </span>
            <input
              id="debridTokenInput"
              [(ngModel)]="debridTokenInput"
              class="form-control"
              [placeholder]="getTokenPlaceholder()"
              (input)="onTokenChange($event)"
              type="password"
              [class.is-valid]="hasValidToken()"
              [class.is-invalid]="debridTokenInput && !hasValidToken()"
              aria-describedby="debridTokenHelp"
            />
            <button
              class="btn btn-outline-secondary"
              (click)="copyToken()"
              type="button"
              [attr.aria-label]="'DASHBOARD.ARIA.COPY_TOKEN' | translate"
            >
              <i class="bi bi-clipboard" aria-hidden="true"></i>
            </button>
          </div>
          @if (debridTokenInput && !hasValidToken()) {
          <div id="debridTokenHelp" class="text-danger small">
            <i class="bi bi-exclamation-circle me-1" aria-hidden="true"></i>
            {{
              "DASHBOARD.DEBRID_SECTION.TOKEN_ERROR"
                | translate
                  : { length: debridService.currentService()!.tokenLength }
            }}
          </div>
          }
        </div>
        }
      </div>

      <!-- Informaci贸n de usuarios conectados -->
      <div class="row g-2 mb-3">
        @if (stremio.user(); as stremioUser) {
        <div class="col-md-6">
          <div
            class="alert alert-info py-2 d-flex align-items-center mb-0"
            role="status"
            aria-live="polite"
          >
            <i class="bi bi-person-check-fill me-2" aria-hidden="true"></i>
            <small
              ><strong>{{ "DASHBOARD.USER_INFO.STREMIO" | translate }}:</strong>
              {{ stremioUser.email }}</small
            >
          </div>
        </div>
        } @if (debridService.user(); as user) {
        <div class="col-md-6">
          <div
            class="alert alert-success py-2 d-flex align-items-center mb-0"
            role="status"
            aria-live="polite"
          >
            <i class="bi bi-check-circle-fill me-2" aria-hidden="true"></i>
            <small
              ><strong
                >{{ debridService.currentService()!.displayName }}:</strong
              >
              {{ user.username }}</small
            >
          </div>
        </div>
        }
      </div>

      <!-- Selector de configuraci贸n predefinida -->
      <div class="row g-3 mb-3">
        <div class="col-12">
          <section aria-labelledby="preset-section-title">
            <div class="d-flex align-items-center mb-3">
              <i
                class="bi bi-collection text-primary me-2 fs-5"
                aria-hidden="true"
              ></i>
              <label
                id="preset-section-title"
                class="form-label mb-0 fw-semibold"
              >
                {{ "DASHBOARD.PRESET_SECTION.TITLE" | translate }}
              </label>
            </div>
            <div class="row g-2">
              @for (preset of availablePresets(); track preset.id) {
              <div class="col-md-6 col-lg-3 d-flex">
                <input
                  type="radio"
                  class="btn-check"
                  [id]="'preset-' + preset.id"
                  name="preset"
                  [value]="preset.id"
                  [(ngModel)]="selectedPreset"
                  aria-labelledby="preset-section-title"
                />
                <label
                  [for]="'preset-' + preset.id"
                  class="btn btn-outline-primary w-100 text-start p-3 d-flex h-100"
                >
                  <div class="d-flex align-items-center w-100">
                    <span class="fs-4 me-2">{{ preset.icon }}</span>
                    <div class="flex-grow-1">
                      <div class="fw-semibold">{{ preset.name | translate }}</div>
                      @if (preset.requiresToken) {
                      <div class="mt-1">
                        <span class="badge bg-warning text-dark">
                          <i class="bi bi-key me-1" aria-hidden="true"></i>
                          {{
                            debridService.currentService()
                              ? ('PRESETS.REQUIRE' | translate) + ' ' +
                                debridService.currentService()!.displayName
                              : ('PRESETS.REQUIRE_DEBRID' | translate)
                          }}
                        </span>
                      </div>
                      }
                    </div>
                  </div>
                </label>
              </div>
              }
            </div>
            <!-- Informaci贸n de la configuraci贸n seleccionada -->
            <div class="card bg-light mt-3">
              <div class="card-body p-3">
                <div class="row">
                  <div class="col-md-8">
                    <h2 class="fw-semibold mb-2 fs-5">
                      {{ currentPreset().icon }} {{ currentPreset().name | translate }}
                    </h2>
                    <p class="mb-2 text-muted">
                      {{ currentPreset().description | translate }}
                    </p>
                    <div class="mb-2">
                      <strong
                        >{{
                          "DASHBOARD.PRESET_SECTION.ADDONS_INCLUDED" | translate
                        }}
                        ({{ availablePresetAddons().length }}):</strong
                      >
                      <span class="ms-1">{{
                        availablePresetAddonsNames()
                      }}</span>
                    </div>
                    @if (unavailablePresetAddons().length > 0) {
                    <div class="mb-2">
                      <small class="text-muted">
                        <strong
                          >{{
                            "DASHBOARD.PRESET_SECTION.NOT_AVAILABLE"
                              | translate
                                : {
                                    language:
                                      preferences.currentLanguageConfig()
                                        .nativeName
                                  }
                          }}:</strong
                        >
                        <span class="ms-1">{{
                          unavailablePresetAddons().join(", ")
                        }}</span>
                      </small>
                    </div>
                    }
                  </div>
                  <div class="col-md-4">
                    <h3 class="fw-semibold mb-2 fs-6">
                      {{ "DASHBOARD.PRESET_SECTION.BENEFITS" | translate }}
                    </h3>
                    <ul class="list-unstyled mb-0">
                      @for (benefit of currentPreset().benefits; track benefit)
                      {
                      <li class="small text-success">
                        <i
                          class="bi bi-check-circle-fill me-1"
                          aria-hidden="true"
                        ></i>
                        {{ benefit | translate }}
                      </li>
                      }
                    </ul>
                  </div>
                </div>
              </div>
            </div>
            <!-- Opciones adicionales -->
            <div class="card bg-light mt-3">
              <div class="card-body p-3">
                <h4 class="fw-semibold mb-3 fs-6">
                  <i class="bi bi-gear-fill me-2" aria-hidden="true"></i>
                  {{
                    "DASHBOARD.PRESET_SECTION.ADDITIONAL_OPTIONS" | translate
                  }}
                </h4>
                <div class="form-check mt-2">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="includeCinemetaAddon"
                    [(ngModel)]="includeCinemetaAddons"
                  />
                  <label class="form-check-label" for="includeCinemetaAddon">
                    <i
                      class="bi bi-film me-2 text-secondary"
                      aria-hidden="true"
                    ></i>
                    <strong>{{
                      "DASHBOARD.PRESET_SECTION.INCLUDE_CINEMETA" | translate
                    }}</strong>
                    <small class="text-muted d-block">
                      {{
                        "DASHBOARD.PRESET_SECTION.INCLUDE_CINEMETA_HELP"
                          | translate
                      }}
                    </small>
                  </label>
                </div>
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="includeAnimeAddons"
                    [(ngModel)]="includeAnimeAddons"
                  />
                  <label class="form-check-label" for="includeAnimeAddons">
                    <i class="bi bi-tv me-2 text-info" aria-hidden="true"></i>
                    <strong>{{
                      "DASHBOARD.PRESET_SECTION.INCLUDE_ANIME" | translate
                    }}</strong>
                    <small class="text-muted d-block">
                      {{
                        "DASHBOARD.PRESET_SECTION.INCLUDE_ANIME_HELP"
                          | translate
                      }}
                    </small>
                  </label>
                </div>
                @if (showCinemetaAddons() || showAnimeAddons()) {
                <div
                  class="mt-2 ms-4 d-flex align-items-center flex-wrap gap-2"
                >
                  @if (showCinemetaAddons()) {
                  <span class="badge bg-secondary text-white">
                    <i class="bi bi-plus-circle me-1" aria-hidden="true"></i>
                    Cinemeta
                  </span>
                  } @if (showAnimeAddons()) {
                  <span class="badge bg-info text-white">
                    <i class="bi bi-plus-circle me-1" aria-hidden="true"></i>
                    Anime Kitsu
                  </span>
                  <span class="badge bg-info text-white">
                    <i class="bi bi-plus-circle me-1" aria-hidden="true"></i>
                    Animes' Season
                  </span>
                  }
                </div>
                }
              </div>
            </div>
          </section>
        </div>
      </div>

      <!-- SubHero languages selection -->
      <div class="card bg-light mt-3">
        <div class="card-body p-3">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="fw-semibold mb-0">
              <i class="bi bi-translate me-2"></i>
              {{ "DASHBOARD.SUBHERO.TITLE" | translate }}
              <small class="text-muted ms-2"
                >{{ subheroSelectedCount() }}
                {{ "DASHBOARD.SUBHERO.SELECTED" | translate }}</small
              >
            </h6>
            <div
              class="btn-group btn-group-sm"
              role="group"
              [attr.aria-label]="'DASHBOARD.ARIA.SUBHERO_ACTIONS' | translate"
            >
              <button
                type="button"
                class="btn btn-outline-secondary"
                (click)="selectAllSubheroLangs()"
              >
                {{ "COMMON.SELECT_ALL" | translate }}
              </button>
              <button
                type="button"
                class="btn btn-outline-secondary"
                (click)="clearAllSubheroLangs()"
              >
                {{ "COMMON.CLEAR_ALL" | translate }}
              </button>
            </div>
          </div>

          <div class="d-flex flex-wrap gap-2 mb-2">
            @for (lang of languageOptions(); track lang.key) {
            <div class="form-check form-check-inline">
              <input
                class="form-check-input"
                type="checkbox"
                [id]="'subhero-' + lang.key"
                [checked]="
                  preferences.selectedSubheroLanguages() &&
                  preferences
                    .selectedSubheroLanguages()
                    .includes(lang.config.code)
                "
                (change)="
                  onToggleSubheroLang(
                    lang.config.code,
                    $any($event.target).checked
                  )
                "
              />
              <label class="form-check-label" [for]="'subhero-' + lang.key">
                {{ lang.config.flag }} {{ lang.config.nativeName }}
              </label>
            </div>
            }
          </div>

          <div class="form-text">
            {{ "DASHBOARD.SUBHERO.HELP" | translate }}
          </div>
        </div>
      </div>

      <div class="d-flex gap-2 flex-wrap mt-3">
        <button
          class="btn btn-primary"
          (click)="configureAll()"
          [disabled]="!canInstallPreset()"
          type="button"
          [attr.aria-label]="
            ('ADDONS.INSTALL' | translate) + ' ' + (currentPreset().name | translate)
          "
        >
          <i class="bi bi-cloud-download me-2" aria-hidden="true"></i>
          {{ "ADDONS.INSTALL" | translate }} {{ currentPreset().name | translate }}
        </button>
        <button
          class="btn btn-outline-warning"
          (click)="resetStremio()"
          [disabled]="isLoading()"
          type="button"
          [attr.aria-label]="'DASHBOARD.BUTTONS.FACTORY_RESET' | translate"
        >
          <i class="bi bi-arrow-counterclockwise me-2" aria-hidden="true"></i>
          {{ "DASHBOARD.BUTTONS.FACTORY_RESET" | translate }}
        </button>
      </div>
    </div>
  </section>

  <!-- Overlay de carga -->
  @if (isLoading()) {
  <div
    class="global-overlay"
    role="alertdialog"
    aria-modal="true"
    [attr.aria-label]="'COMMON.LOADING' | translate"
  >
    <div
      class="card bg-dark text-light shadow-lg border-0"
      style="min-width: 320px; max-width: 400px"
    >
      <div class="card-body text-center p-4">
        <div class="d-flex justify-content-center mb-3">
          <div
            class="spinner-border text-light"
            style="width: 3rem; height: 3rem"
            role="status"
            aria-live="assertive"
          >
            <span class="visually-hidden">{{
              "COMMON.LOADING" | translate
            }}</span>
          </div>
        </div>
        <h2 class="fw-semibold mb-2 fs-5">{{ loadingTitle() | translate }}</h2>
        <p class="mb-0 text-light-emphasis">{{ progressText() }}</p>
      </div>
    </div>
  </div>
  }

  <!-- Componente de addons -->
  <section [attr.aria-label]="'ADDONS.TITLE' | translate">
    <app-addons
      [stremioAuthKey]="stremio.authKey() || ''"
      [rdToken]="debridService.token() || ''"
      (refreshRequested)="reloadAddons()"
    />
  </section>

  <!-- Tabs de addons iframe -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0 fw-bold text-secondary fs-4">
      <i class="bi bi-grid-3x3-gap me-2" aria-hidden="true"></i>
      {{ "DASHBOARD.CUSTOMIZABLE_ADDONS" | translate }}
    </h2>
    <button
      class="btn btn-outline-secondary btn-sm d-flex align-items-center"
      type="button"
      data-bs-toggle="collapse"
      data-bs-target="#addonTabsSection"
      [attr.aria-expanded]="!addonTabsCollapsed"
      aria-controls="addonTabsSection"
      [attr.aria-label]="'DASHBOARD.ARIA.TOGGLE_CUSTOMIZABLE' | translate"
      (click)="toggleAddonTabs()"
      [title]="
        addonTabsCollapsed
          ? ('DASHBOARD.SHOW_ADDONS' | translate)
          : ('DASHBOARD.HIDE_ADDONS' | translate)
      "
    >
      <i
        [class]="addonTabsCollapsed ? 'bi bi-chevron-down' : 'bi bi-chevron-up'"
        aria-hidden="true"
      ></i>
      <span class="d-none d-sm-inline ms-1">
        {{
          addonTabsCollapsed
            ? ("COMMON.SHOW" | translate)
            : ("COMMON.HIDE" | translate)
        }}
      </span>
    </button>
  </div>

  <section
    id="addonTabsSection"
    [class]="'collapse' + (!addonTabsCollapsed ? ' show' : '')"
    [attr.aria-label]="'DASHBOARD.CUSTOMIZABLE_ADDONS' | translate"
  >
    <app-addon-tabs
      [addons]="filteredAddons()"
      [token]="debridService.token() || ''"
      [language]="preferences.selectedLanguage()"
    />
  </section>
</main>
